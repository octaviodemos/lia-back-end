// This is your Prisma schema file for Projeto LIA
// Model: Loja Pessoal + Serviços

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "windows"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- Grupo 1: Entidades Centrais ---

model Usuario {
  id_usuario   Int      @id @default(autoincrement())
  nome         String   @db.VarChar(255)
  email        String   @unique @db.VarChar(255)
  senha        String   @db.VarChar(255)
  telefone     String?  @db.VarChar(20)
  tipo_usuario String   @db.VarChar(50) // 'cliente', 'admin'
  created_at   DateTime @default(now())

  // Relacionamentos
  carrinho             Carrinho?
  pedidos              Pedido[]
  enderecos_entrega    EnderecosEntrega[]
  ofertas_venda        OfertaVenda[]
  solicitacoes_reforma SolicitacaoReforma[]
  avaliacoes           Avaliacao[]
  publicacoes          Publicacao[]
  publicacao_comentarios PublicacaoComentario[]
  publicacao_curtidas  PublicacaoCurtida[]

  @@map("usuarios")
}

model Livro {
  id_livro       Int      @id @default(autoincrement())
  titulo         String   @db.VarChar(255)
  sinopse        String?  @db.Text
  editora        String?  @db.VarChar(255)
  ano_publicacao Int?
  isbn           String?  @unique @db.VarChar(20)
  capa_url       String?  @db.VarChar(255)

  // Relacionamentos
  estoque    Estoque[]
  autores    LivroAutor[]
  generos    LivroGenero[]
  avaliacoes Avaliacao[]

  @@map("livros")
}

model Autor {
  id_autor      Int          @id @default(autoincrement())
  nome_completo String       @db.VarChar(255)
  livros        LivroAutor[]

  @@map("autores")
}

model Genero {
  id_genero Int           @id @default(autoincrement())
  nome      String        @unique @db.VarChar(100)
  livros    LivroGenero[]

  @@map("generos")
}


// --- Grupo 2: Módulo de Vendas da LIA (E-commerce) ---

model Estoque {
  id_estoque Int     @id @default(autoincrement())
  id_livro   Int
  quantidade Int     @default(1)
  preco      Decimal @db.Decimal(10, 2)
  condicao   String? @db.VarChar(100)

  livro          Livro           @relation(fields: [id_livro], references: [id_livro])
  carrinho_itens CarrinhoItem[]
  itens_pedido   ItemPedido[]

  @@map("estoque")
}

model Carrinho {
  id_carrinho Int            @id @default(autoincrement())
  id_usuario  Int            @unique
  created_at  DateTime       @default(now())

  usuario     Usuario        @relation(fields: [id_usuario], references: [id_usuario])
  itens       CarrinhoItem[]

  @@map("carrinho")
}

model CarrinhoItem {
  id_carrinho_item Int      @id @default(autoincrement())
  id_carrinho      Int
  id_estoque       Int
  quantidade       Int
  added_at         DateTime @default(now())

  carrinho Carrinho @relation(fields: [id_carrinho], references: [id_carrinho])
  estoque  Estoque  @relation(fields: [id_estoque], references: [id_estoque])

  @@map("carrinho_itens")
}

model Pedido {
  id_pedido       Int          @id @default(autoincrement())
  id_cliente      Int
  data_pedido     DateTime     @default(now())
  status_pedido   String       @db.VarChar(50)
  codigo_rastreio String?      @db.VarChar(100)
  data_envio      DateTime?    @db.Date

  cliente   Usuario      @relation(fields: [id_cliente], references: [id_usuario])
  itens     ItemPedido[]
  pagamento Pagamento?

  @@map("pedidos")
}

model ItemPedido {
  id_item        Int     @id @default(autoincrement())
  id_pedido      Int
  id_estoque     Int
  quantidade     Int
  preco_unitario Decimal @db.Decimal(10, 2)

  pedido  Pedido  @relation(fields: [id_pedido], references: [id_pedido])
  estoque Estoque @relation(fields: [id_estoque], references: [id_estoque])

  @@map("itens_pedido")
}

model EnderecosEntrega {
  id_endereco Int     @id @default(autoincrement())
  id_cliente  Int
  rua         String? @db.VarChar(255)
  cidade      String? @db.VarChar(100)
  estado      String? @db.VarChar(50)
  cep         String? @db.VarChar(10)
  numero      String? @db.VarChar(20)
  complemento String? @db.VarChar(100)

  cliente Usuario @relation(fields: [id_cliente], references: [id_usuario])

  @@map("enderecos_entrega")
}

model Pagamento {
  id_pagamento             Int       @id @default(autoincrement())
  id_pedido                Int       @unique
  status_pagamento         String    @db.VarChar(50)
  id_transacao_gateway     String?   @db.VarChar(255)
  data_pagamento           DateTime? @default(now())

  valor_pago               Decimal?  @db.Decimal(10, 2)
  taxas_gateway            Decimal?  @db.Decimal(10, 2)
  metodo_pagamento         String?   @db.VarChar(50)
  parcelas                 Int?
  link_boleto              String?   @db.Text
  qr_code_pix              String?   @db.Text
  data_expiracao_pix       DateTime?
  payload_completo_gateway Json?

  pedido Pedido @relation(fields: [id_pedido], references: [id_pedido])

  @@map("pagamentos")
}


// --- Grupo 3: Módulo de Serviços e Aquisições ---

model OfertaVenda {
  id_oferta_venda Int      @id @default(autoincrement())
  id_usuario      Int
  titulo_livro    String   @db.VarChar(255)
  autor_livro     String?  @db.VarChar(255)
  isbn            String?  @db.VarChar(20)
  condicao_livro  String   @db.Text
  preco_sugerido  Decimal  @db.Decimal(10, 2)
  status_oferta   String   @default("pendente") @db.VarChar(50)
  data_oferta     DateTime @default(now())
  resposta_admin  String?  @db.Text

  usuario Usuario @relation(fields: [id_usuario], references: [id_usuario])

  @@map("ofertas_venda")
}

model SolicitacaoReforma {
  id_solicitacao     Int      @id @default(autoincrement())
  id_usuario         Int
  descricao_problema String   @db.Text
  status_solicitacao String   @default("pendente") @db.VarChar(50)
  data_solicitacao   DateTime @default(now())

  usuario Usuario                  @relation(fields: [id_usuario], references: [id_usuario])
  fotos   FotoSolicitacaoReforma[]

  @@map("solicitacoes_reforma")
}

model FotoSolicitacaoReforma {
  id_foto        Int    @id @default(autoincrement())
  id_solicitacao Int
  url_foto       String @db.VarChar(255)

  solicitacao SolicitacaoReforma @relation(fields: [id_solicitacao], references: [id_solicitacao])

  @@map("fotos_solicitacao_reforma")
}


// --- Grupo 4: Módulo de Comunidade ---

model Avaliacao {
  id_avaliacao   Int      @id @default(autoincrement())
  id_livro       Int
  id_usuario     Int
  nota           Int
  comentario     String?  @db.Text
  data_avaliacao DateTime @default(now())

  livro   Livro   @relation(fields: [id_livro], references: [id_livro])
  usuario Usuario @relation(fields: [id_usuario], references: [id_usuario])

  @@map("avaliacoes")
}

model Publicacao {
  id_publicacao   Int                    @id @default(autoincrement())
  id_usuario      Int
  titulo          String?                @db.VarChar(255)
  conteudo        String                 @db.Text
  data_publicacao DateTime               @default(now())

  usuario     Usuario                @relation(fields: [id_usuario], references: [id_usuario])
  comentarios PublicacaoComentario[]
  curtidas    PublicacaoCurtida[]

  @@map("publicacoes")
}

model PublicacaoComentario {
  id_comentario   Int      @id @default(autoincrement())
  id_publicacao   Int
  id_usuario      Int
  conteudo        String   @db.Text
  data_comentario DateTime @default(now())

  publicacao Publicacao @relation(fields: [id_publicacao], references: [id_publicacao])
  usuario    Usuario    @relation(fields: [id_usuario], references: [id_usuario])

  @@map("publicacao_comentarios")
}

model PublicacaoCurtida {
  id_publicacao Int
  id_usuario    Int

  publicacao Publicacao @relation(fields: [id_publicacao], references: [id_publicacao])
  usuario    Usuario    @relation(fields: [id_usuario], references: [id_usuario])

  @@id([id_publicacao, id_usuario])
  @@map("publicacao_curtidas")
}


// --- Grupo 5: Tabelas-Pivô (Muitos-para-Muitos) ---

model LivroAutor {
  id_livro Int
  id_autor Int

  livro Livro @relation(fields: [id_livro], references: [id_livro])
  autor Autor @relation(fields: [id_autor], references: [id_autor])

  @@id([id_livro, id_autor])
  @@map("livro_autor")
}

model LivroGenero {
  id_livro  Int
  id_genero Int

  livro  Livro  @relation(fields: [id_livro], references: [id_livro])
  genero Genero @relation(fields: [id_genero], references: [id_genero])

  @@id([id_livro, id_genero])
  @@map("livro_genero")
}