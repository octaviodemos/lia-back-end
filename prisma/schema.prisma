// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "windows"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- Grupo 1: Entidades Centrais ---

model Usuario {
  id_usuario   Int      @id @default(autoincrement())
  nome         String   @db.VarChar(255)
  email        String   @unique @db.VarChar(255)
  senha        String   @db.VarChar(255)
  tipo_usuario String   @db.VarChar(50)

  sebo                   Sebo?
  carrinho               Carrinho?
  pedidos                Pedido[]
  enderecos_entrega      EnderecosEntrega[]
  avaliacoes             Avaliacao[]
  publicacoes            Publicacao[]
  publicacao_comentarios PublicacaoComentario[]
  publicacao_curtidas    PublicacaoCurtida[]

  @@map("usuarios")
}

model Sebo {
  id_sebo           Int         @id @default(autoincrement())
  id_usuario        Int         @unique
  nome_fantasia     String      @db.VarChar(255)
  cnpj              String?     @unique @db.VarChar(18)
  endereco_completo String?     @db.Text
  logo_url          String?     @db.VarChar(255)

  usuario           Usuario     @relation(fields: [id_usuario], references: [id_usuario])
  livros_em_estoque LivroSebo[]

  @@map("sebo")
}

model Livro {
  id_livro       Int      @id @default(autoincrement())
  titulo         String   @db.VarChar(255)
  sinopse        String?  @db.Text
  editora        String?  @db.VarChar(255)
  ano_publicacao Int?
  isbn           String?  @unique @db.VarChar(20)
  capa_url       String?  @db.VarChar(255)

  autores    LivroAutor[]
  generos    LivroGenero[]
  no_sebos   LivroSebo[]
  avaliacoes Avaliacao[]

  @@map("livros")
}

model Autor {
  id_autor      Int          @id @default(autoincrement())
  nome_completo String       @db.VarChar(255)
  livros        LivroAutor[]

  @@map("autores")
}

model Genero {
  id_genero Int           @id @default(autoincrement())
  nome      String        @unique @db.VarChar(100)
  livros    LivroGenero[]

  @@map("generos")
}


// --- Grupo 2: E-commerce ---

model LivroSebo {
  id_livro_sebo Int      @id @default(autoincrement())
  id_livro      Int
  id_sebo       Int
  quantidade    Int      @default(1)
  preco_sebo    Decimal  @db.Decimal(10, 2)
  condicao      String?  @db.VarChar(100)

  livro          Livro           @relation(fields: [id_livro], references: [id_livro])
  sebo           Sebo            @relation(fields: [id_sebo], references: [id_sebo])
  carrinho_itens CarrinhoItem[]
  itens_pedido   ItemPedido[]

  @@map("livro_sebo")
}

model Carrinho {
  id_carrinho Int            @id @default(autoincrement())
  id_usuario  Int            @unique
  usuario     Usuario        @relation(fields: [id_usuario], references: [id_usuario])
  itens       CarrinhoItem[]

  @@map("carrinho")
}

model CarrinhoItem {
  id_carrinho_item Int @id @default(autoincrement())
  id_carrinho      Int
  id_livro_sebo    Int
  quantidade       Int

  carrinho  Carrinho  @relation(fields: [id_carrinho], references: [id_carrinho])
  livro_sebo LivroSebo @relation(fields: [id_livro_sebo], references: [id_livro_sebo])

  @@map("carrinho_itens")
}

model Pedido {
  id_pedido       Int          @id @default(autoincrement())
  id_cliente      Int
  data_pedido     DateTime     @default(now())
  status_pedido   String       @db.VarChar(50)
  codigo_rastreio String?      @db.VarChar(100)
  data_envio      DateTime?    @db.Date

  cliente       Usuario      @relation(fields: [id_cliente], references: [id_usuario])
  itens         ItemPedido[]
  pagamento     Pagamento?

  @@map("pedidos")
}

model ItemPedido {
  id_item        Int     @id @default(autoincrement())
  id_pedido      Int
  id_livro_sebo  Int
  quantidade     Int
  preco_unitario Decimal @db.Decimal(10, 2)

  pedido     Pedido    @relation(fields: [id_pedido], references: [id_pedido])
  livro_sebo LivroSebo @relation(fields: [id_livro_sebo], references: [id_livro_sebo])

  @@map("itens_pedido")
}

model EnderecosEntrega {
  id_endereco Int     @id @default(autoincrement())
  id_cliente  Int
  rua         String? @db.VarChar(255)
  cidade      String? @db.VarChar(100)
  estado      String? @db.VarChar(50)
  cep         String? @db.VarChar(10)
  numero      String? @db.VarChar(20)
  complemento String? @db.VarChar(100)

  cliente Usuario @relation(fields: [id_cliente], references: [id_usuario])

  @@map("enderecos_entrega")
}

model Pagamento {
  id_pagamento            Int      @id @default(autoincrement())
  id_pedido               Int      @unique
  status_pagamento        String   @db.VarChar(50) // Ex: pending, approved, rejected
  id_transacao_gateway    String?  @db.VarChar(255) // ID do pagamento no Mercado Pago
  
  // --- Campos opcionais para mais detalhes ---
  valor_pago              Decimal? @db.Decimal(10, 2) // Valor final confirmado pelo gateway
  taxas_gateway           Decimal? @db.Decimal(10, 2) // Taxas cobradas pelo MP
  metodo_pagamento        String?  @db.VarChar(50) // Ex: credit_card, pix, boleto
  parcelas                Int?     // Número de parcelas (ex: 1, 3, 12)
  link_boleto             String?  @db.Text // Se o método for boleto, guardar o link
  qr_code_pix             String?  @db.Text // Se for PIX, guardar o código do QR Code
  data_expiracao_pix      DateTime? // Data de expiração do QR Code do PIX
  payload_completo_gateway Json?   // [MUITO ÚTIL] Guarda o JSON completo do último webhook recebido para depuração

  pedido Pedido @relation(fields: [id_pedido], references: [id_pedido])

  @@map("pagamentos")
}


// --- Grupo 3: Comunidade e Interação ---

model Avaliacao {
  id_avaliacao   Int      @id @default(autoincrement())
  id_livro       Int
  id_usuario     Int
  nota           Int
  comentario     String?  @db.Text
  data_avaliacao DateTime @default(now())

  livro   Livro   @relation(fields: [id_livro], references: [id_livro])
  usuario Usuario @relation(fields: [id_usuario], references: [id_usuario])

  @@map("avaliacoes")
}

model Publicacao {
  id_publicacao   Int                    @id @default(autoincrement())
  id_usuario      Int
  titulo          String?                @db.VarChar(255)
  conteudo        String                 @db.Text
  data_publicacao DateTime               @default(now())

  usuario         Usuario                @relation(fields: [id_usuario], references: [id_usuario])
  comentarios     PublicacaoComentario[]
  curtidas        PublicacaoCurtida[]

  @@map("publicacoes")
}

model PublicacaoComentario {
  id_comentario   Int      @id @default(autoincrement())
  id_publicacao   Int
  id_usuario      Int
  conteudo        String   @db.Text
  data_comentario DateTime @default(now())

  publicacao Publicacao @relation(fields: [id_publicacao], references: [id_publicacao])
  usuario    Usuario    @relation(fields: [id_usuario], references: [id_usuario])

  @@map("publicacao_comentarios")
}

model PublicacaoCurtida {
  id_publicacao Int
  id_usuario    Int

  publicacao Publicacao @relation(fields: [id_publicacao], references: [id_publicacao])
  usuario    Usuario    @relation(fields: [id_usuario], references: [id_usuario])

  @@id([id_publicacao, id_usuario])
  @@map("publicacao_curtidas")
}


// --- Grupo 4: Tabelas de Relacionamento (Muitos-para-Muitos) ---

model LivroAutor {
  id_livro Int
  id_autor Int

  livro Livro @relation(fields: [id_livro], references: [id_livro])
  autor Autor @relation(fields: [id_autor], references: [id_autor])

  @@id([id_livro, id_autor])
  @@map("livro_autor")
}

model LivroGenero {
  id_livro  Int
  id_genero Int

  livro  Livro  @relation(fields: [id_livro], references: [id_livro])
  genero Genero @relation(fields: [id_genero], references: [id_genero])

  @@id([id_livro, id_genero])
  @@map("livro_genero")
}